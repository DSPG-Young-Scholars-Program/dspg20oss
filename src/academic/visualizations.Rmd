---
title: "Data Viz"
author: "Morgan Klutzke"
date: "7/7/2020"
output: html_document
---

```{r}
# get some good numbers
percent_us_institution <- length(filter(df, country_code == "US")$organization) / length(df$organization) # 0.332
percent_us_users <- sum(filter(df, country_code == "US")[, "n"]) / sum(df[, "n"]) # 0.587
percent_academic_users <- sum(df[,"n"]) / 2435698 # 0.0145

options(scipen = 10)
country_user_percentages <- df %>% group_by(country) %>% select(country, n) %>% summarise(n = sum(n) / sum(df[, "n"])) %>% arrange(-n)
country_user_percentages
```

```{r}
country_frequency_users <- df %>% group_by(country) %>% count(sort = TRUE)
country_frequency_institutions <- df %>% group_by(country) %>% count(wt = n(), sort = TRUE)
```

Sunburst chart

```{r}
# NO
library(plotly)

us_5 <- df %>% filter(country == "United States") %>% dt_mutate(organization = fct_reorder(organization, n))
us_5 <- us_5[1:5, ]
cn_5 <- df %>% filter(country == "China") %>% dt_mutate(organization = fct_reorder(organization, n))
cn_5 <- cn_5[1:5, ]
uk_5 <- df %>% filter(country == "United Kingdom") %>% dt_mutate(organization = fct_reorder(organization, n))
uk_5 <- uk_5[1:5, ]
ca_5 <- df %>% filter(country == "Canada") %>% dt_mutate(organization = fct_reorder(organization, n))
ca_5 <- ca_5[1:5, ]
jp_5 <- df %>% filter(country == "Japan") %>% dt_mutate(organization = fct_reorder(organization, n))
jp_5 <- jp_5[1:5, ]

labels <- country_frequency_users$country[1:5] %>%
  append(us_5$organization) %>%
  append(cn_5$organization) %>%
  append(uk_5$organization) %>%
  append(ca_5$organization) %>%
  append(jp_5$organization)

parents <- c("", "", "", "", "") %>%
  append(rep("United States", length.out = 5)) %>%
  append(rep("China", length.out = 5)) %>%
  append(rep("United Kingdom", length.out = 5)) %>%
  append(rep("Canada", length.out = 5)) %>%
  append(rep("Japan", length.out = 5))

values <- country_frequency_users$n[1:5] %>%
  append(us_5$n) %>%
  append(cn_5$n) %>%
  append(uk_5$n) %>%
  append(ca_5$n) %>%
  append(jp_5$n)

fig <- plot_ly(
  labels = labels, 
  parents = parents,
  values = values,
  type = 'sunburst'
)

fig
```



```{r}
# NO
grid.arrange(ggplot(us_5, aes(x = organization, y = n)) + geom_col() + coord_flip(),
             ggplot(uk_5, aes(x = organization, y = n)) + geom_col() + coord_flip(),
             ggplot(cn_5, aes(x = organization, y = n)) + geom_col() + coord_flip(),
             ggplot(ca_5, aes(x = organization, y = n)) + geom_col() + coord_flip())
```



```{r,fig.height=7}
df_sorted <- df %>%
  arrange(n) %>%
  #arrange(desc(n))[1:50, ] %>%
  dt_mutate(organization = factor(organization, levels = organization))


ggplot(df_sorted[(.N-50):.N, ], aes(color = country)) +
  geom_point(aes(x = organization, y = n)) +
  geom_segment(data = df_sorted[(.N-50):.N, ], mapping = aes(x = organization, xend = organization, y = 0, yend = n)) +
  scale_color_manual(values = c("United States" = "#8F8F8F", "China" = "#E57200", "United Kingdom" = "#12B2CE", "Canada" = "#485C99")) +
  labs(x = "Academic Institution", y = "Number of Users", color = "Country") +
  theme_classic() +
  coord_flip()

ggplot(df_sorted[(.N-20):.N, ], aes(color = country)) +
  geom_point(aes(x = organization, y = n)) +
  geom_segment(data = df_sorted[(.N-20):.N, ], mapping = aes(x = organization, xend = organization, y = 0, yend = n)) +
  scale_color_manual(values = c("United States" = "#485C99", "China" = "#E57200", "Canada" = "#12B2CE")) +
  labs(x = "Academic Institution", y = "Number of Users", color = "Country", title = "Top 20 universities by number of users") +
  #theme_classic() +
  coord_flip()
```


```{r,fig.height=7}
us_df <- df_sorted %>% filter(country == "United States")

ggplot(us_df[(.N-50):.N, ]) +
  geom_point(aes(x = organization, y = n)) +
  geom_segment(data = us_df[(.N-50):.N, ], mapping = aes(x = organization, xend = organization, y = 0, yend = n)) +
  labs(x = "Academic Institution", y = "Number of Users") +
  theme_classic() +
  coord_flip()
```

```{r,fig.height=7}
country_users_sorted <- country_frequency_users %>%
  arrange(n) %>%
  #arrange(desc(n))[1:50, ] %>%
  dt_mutate(country = factor(country, levels = country))

ggplot(country_users_sorted[(.N-50):.N, ]) +
  geom_point(aes(x = country, y = n)) +
  geom_segment(data = country_users_sorted[(.N-50):.N, ], mapping = aes(x = country, xend = country, y = 0, yend = n)) +
  labs(x = "Country", y = "Number of Users") +
  theme_classic() +
  scale_y_log10() +
  coord_flip()
```

```{r, fig.width=7}
# NO
world <- map_data("world")

choro <- merge(world, df, sort = FALSE, by.x = "region", by.y = "country")
choro <- choro[order(choro$order), ]

ggplot(choro, aes(long, lat)) + 
  geom_polygon(aes(group = group, fill = n)) +
  theme_classic()
```

```{r}

```

