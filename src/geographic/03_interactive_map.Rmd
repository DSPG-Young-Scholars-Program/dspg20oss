---
title: "Github Users Around the World"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    highlight: tango
    theme: journal
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading data, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls())

# load packages 
for (pkg in c("tidyverse", "igraph", "visNetwork", "data.table", "R.utils", "RPostgreSQL", "cowplot", "maditr", "stringr", "stringi", "mosaic", "sf", "raster", "dplyr", "spData", "tmap", "leaflet", "mapview", "ggplot2", "shiny", "maps", "plotly", "RColorBrewer", "leaflet.extras", "rgdal", "rnaturalearth", "rnaturalearthdata", "ggspatial", "maps", "tool", "ggrepel", "tmaptools")) {library(pkg, character.only = TRUE)}

for (pkg in c("tidyverse", "data.table", "R.utils", "RPostgreSQL", "cowplot", "maditr", "stringr", "stringi",  "dplyr")) {library(pkg, character.only = TRUE)}


# connect to postgresql to get our data
conn <- dbConnect(drv = PostgreSQL(), 
                  dbname = "sdad", 
                  host = "10.250.124.195", 
                  port = 5432, 
                  user = Sys.getenv("db_userid"), 
                  password = Sys.getenv("db_pwd"))

# query the users_gh data from github data 
users_gh <- dbGetQuery(conn, "SELECT login, created_at, city, state, country_code, location, long, lat, cc_multiple, cc_vis
                              FROM gh.ctrs_extra")

# disconnect from postgresql database 
dbDisconnect(conn)

source("~/git/dspg20oss/src/geographic/00_functions.R", echo = T, prompt.echo = "", spaced = F)
```

We conduct analysis on github users' geographic location, which is extracted from the user profile. We ackowledge  `r round(sum(is.na(users_gh$country_code) | is.na(users_gh$city))/nrow(users_gh) * 100, digits = 2)` % missing geographic information (country and city name), which leaves us with `r sum(!is.na(users_gh$country_code) & !is.na(users_gh$city))` github users in our analysis. We hypothesized that there is no difference between users with geographic information and users who are missing geographic information (In progress).

```{r clean citycode, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
table(is.na(users_gh$country_code))

ls_cleancity <- cleancity(users_gh)

city_clean_final <- ls_cleancity$cleaned_df


#aggregate by continent
city_clean_final_aggregate_continent<- city_clean_final%>%
  group_by(c_continent_name)%>%
  summarize(ttl_users = n(), `percent (%)` = round(ttl_users/nrow(city_clean_final)*100, digits = 2))%>%
  arrange(desc(ttl_users))

#aggregate by country
city_clean_final_aggregate_country <- city_clean_final%>%
  group_by(c_country_name)%>%
  summarize(ttl_users = n())
#city_clean_final_aggregate_country$country_code <- gsub(" ", "", city_clean_final_aggregate_country$country_code, fixed = TRUE)

#aggregate by city
city_clean_final_aggregate <- city_clean_final%>%
  group_by(c_city_code, c_country_name)%>%
  summarize(ttl_users = n(), lat = mean(raw_lat), long = mean(raw_long))%>%
  arrange(-ttl_users)

city_clean_final_aggregate$city <- str_extract(city_clean_final_aggregate$c_city_code,"_(.*)_") 
city_clean_final_aggregate$city <- gsub("_", "", city_clean_final_aggregate$city, fixed = TRUE)
city_clean_final_aggregate$city<- sapply(city_clean_final_aggregate$city,CapStr)

city_clean_final_aggregate$city_country <- paste(city_clean_final_aggregate$city, city_clean_final_aggregate$c_country_name, sep = ", ")
```

# What Continents are Github Users Located at
North America is the continent that has the highest number of github users, following by Europe, and Asia.
```{r fig.width=8, fig.height=8, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gh_continent<- city_clean_final_aggregate_continent%>%
  arrange(desc(ttl_users))

gh_continent$Continent_Name <- factor(gh_continent$c_continent_name, levels = gh_continent$c_continent_name[order(gh_continent$ttl_users)])

ggplot(gh_continent, aes(x = Continent_Name, y = ttl_users, fill = ttl_users))+
  geom_bar(stat = "identity")+ 
  scale_fill_continuous(low="blue", high="red")+
  labs(title = "Continents where Github users are located", x = "continent", y = "total number of users")+
  theme_bw()
```

# Top Countries Where Github Users are Located
United States is the country that has the highest number of github users, following by China, Great Britain, and India.
```{r fig.width=7, fig.height=10, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gh_country <- city_clean_final_aggregate_country%>%
  arrange(desc(ttl_users))%>%
  top_n(10, ttl_users)

gh_country$Country_Name <- factor(gh_country$c_country_name, levels = gh_country$c_country_name[order(gh_country$ttl_users)])
gh_country <- gh_country %>% 
  mutate(c_country_name = ifelse(test = str_detect(string = c_country_name, pattern = "United States of America"), yes = "USA", no = c_country_name)) %>% 
  mutate(c_country_name = ifelse(test = str_detect(string = c_country_name, pattern = "United Kingdom of Great Britain"), yes = "UK", no = c_country_name)) %>% 
  mutate(c_country_name = ifelse(test = str_detect(string = c_country_name, pattern = "Russian Federation"), yes = "Russia", no = c_country_name))

ggplot(gh_country, aes(x = c_country_name, y = ttl_users, fill = ttl_users)) +
  geom_bar(stat = "identity")+ 
  scale_fill_continuous(low="blue", high="red")+
  labs(title = "Countries where Github users are located", x = "country", y = "total number of users") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


# Top Cities Where Github Users are Located
San Francisco (US) is the city that has the highest number of github users, following by London (UK), New York (US), Moscow (Russia), and Beijing (China).
```{r fig.width=7, fig.height=10, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gh_city <- city_clean_final_aggregate%>%
  arrange(-ttl_users)%>%
 # top_n(10, ttl_users)%>%  #don't know why this code doesn't work
  filter(ttl_users >= 6651) 

gh_city$city_country <- factor(gh_city$city_country, levels = gh_city$city_country[order(gh_city$ttl_users)])
# NOTE ::: Could you please shorten the labels for the USA and Russia cities 

ggplot(gh_city, aes(x = city_country, y = ttl_users, fill = ttl_users))+
  geom_bar(stat = "identity")+ 
  scale_fill_continuous(low="blue", high="red")+
  labs(title = "Countries where Github users are located", x = "city", y = "total number of users") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

# City-level Interactive map
```{r visualization interactive map, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#In this map, the color of the circle indicates the number of github users in each city, still under development.
city_clean_final_aggregate_top <- city_clean_final_aggregate%>%
  filter(ttl_users > 1)%>%
  mutate(ttl_users_t = log(ttl_users), perc = ttl_users_t/max(ttl_users_t))

# hist(city_clean_final_aggregate_top$perc)
# hist(city_clean_final_aggregate_top$perc*255)


# pal <- colorNumeric(palette = c("#51a6b5", "#052e2c"), domain = c(min(city_clean_final_aggregate_top$ttl_users): max(city_clean_final_aggregate_top$ttl_users)), reverse = F)

#Define the breaks and associated RGB value
# vec_breaks <- c(min(city_clean_final_aggregate_top$ttl_users), 5000, 10000, max(city_clean_final_aggregate_top$ttl_users))
# 
# vec_rgb    <- c("#a4fa8c","#6bd64d", "#369e19",  "#196604") 
# 
# #Add a colour column, and put in the appropriate RGB value
for (i in 1:nrow(city_clean_final_aggregate_top)) {
    city_clean_final_aggregate_top$colour[i] <- paste("rgb(", 20 , ",", 150, ",",round( 255*city_clean_final_aggregate_top$perc[i],digits = 0), ")", sep="")
      #city_clean_final_aggregate_top$colour[i] <- vec_rgb[min(which(vec_breaks > city_clean_final_aggregate_top$ttl_users[i])) - 1]
}
 


#ttl user indicated by color
city_clean_final_aggregate_top %>%
  leaflet()%>%
  addTiles()%>%
  addSearchOSM()%>%
  addReverseSearchOSM()%>%
  clearMarkers()%>%
  addResetMapButton()%>%
  addCircleMarkers(
    lng = ~long , 
    lat = ~lat, 
    color =  ~colour,
    label = ~ paste(city, country, sep = ', \n'),
    radius = 2)

# %>%
#   addLegend(title = "Number of Github Users", 
#           pal = ~colour, 
#             values = c(0: 15927), 
#             position = "bottomright", 
#             opacity = 0.5)
  
```

In this map, the size of the circle indicates the number of github users in each city. You can zoom in and hover over the circle to see how many users are in that city. You can also type in the city that you are interested in.
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#ttl user indicated by size
city_clean_final_aggregate %>%
  leaflet()%>%
  addTiles()%>%
  addSearchOSM()%>%
  addReverseSearchOSM()%>%
  clearMarkers()%>%
  addResetMapButton()%>%
  addCircleMarkers(
    lng = ~long , 
    lat = ~lat, 
    label = ~ paste(city_country,", ", ttl_users, " users", sep = ""),
    radius = ~ttl_users^(1/3), 
    color = "green")
```

