---
title: "01_city-code-formation-city-levle-github-users"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r loading data, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls())

# load packages 
for (pkg in c("tidyverse", "igraph", "visNetwork", "data.table", "R.utils", "RPostgreSQL", "cowplot", "maditr", "stringr", "stringi", "mosaic")) {
  library(pkg, character.only = TRUE)
}


# connect to postgresql to get our data
conn <- dbConnect(drv = PostgreSQL(), 
                  dbname = "sdad", 
                  host = "10.250.124.195", 
                  port = 5432, 
                  user = Sys.getenv("db_userid"), 
                  password = Sys.getenv("db_pwd"))

# query the users_gh data from github data 
users_gh <- dbGetQuery(conn, "SELECT login, created_at, city, state, country_code, location, long, lat
                              FROM gh.ctrs_raw")

cities_maxmind <- dbGetQuery(conn, 
"SELECT *
  FROM maxmind.world_cities"
)

# too large to read in the raw commit data. Will crash R
# commits <- dbGetQuery(conn,
#                       "SELECT *
#                       FROM gh.commits_raw")

# disconnect from postgresql database 
dbDisconnect(conn)
```


```{r eda, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# 1. github user

# check: users who don't have any of city, state, location, long, lat, don't have country code
# user_geo_na <- users_gh %>%
#   filter(is.na(state))%>%
#   filter(is.na(city))%>%
#   filter(is.na(location))%>%
#   filter(is.na(long), is.na(lat))
# table(is.na(user_geo_na$country_code)) #all users have country code

# filter out users with no country/city
sum(is.na(users_gh$country_code) | is.na(users_gh$city))/nrow(users_gh) #percent missing

# some users who are missing country code have cities, but cities might not be reliable
users_gh_countrycode_na <- users_gh%>%
  filter(is.na(country_code))

# check: users created year
# class(users_gh$created_at) 
# users_gh_clean <- users_gh_clean %>%
#   mutate(created_year = substring(created_at, 1,4)) #extract year from the date
# table(users_gh_clean$created_year)
```

# Country Level Github Users
```{r country level, echo=FALSE}
# summarize ttl number of users in each country
country_by_ttl_user <- users_gh%>%
  filter(!is.na(country_code))%>%
  group_by(country_code)%>%
  dplyr::summarize(ttl_users = n())%>%
  arrange(desc(ttl_users)) %>%
  top_n(n= 10, wt = ttl_users)

country_by_ttl_user$country_code <- factor(country_by_ttl_user$country_code, levels = country_by_ttl_user$country_code[order(country_by_ttl_user$ttl_users)])

ggplot(country_by_ttl_user, aes(x = country_code, y = ttl_users)) +
  geom_point() +
  labs(title = "Countries where Github users are located", x = "c", y = "total number of users") +
  theme_bw() 
```



# City code formation
1. We exclude users who did not provide either country code or city information. (77% missing) Note that country code is extracted from country, city, loaction, and longitude and latitude. Country code is missing if the user did not provide any of these information. Since we are interested in users at the city level, if we are missing city information, we could not extract a unique city. 

2. First, we want to differentiate cities from different countries. We form a new variable "city_code", which is a concactinated form of country code and city. Since there could be multiples cities with the same name in different countries, "city_code" can be used to differentiate cities from from different countries.

3. Next, we want to differentiate cities within a country. Although we have state variable, but we decide no to use this variable due to the inaccurate report. We decide to use longitude and latitude to differentiate cities in different areas in a country. However, longtitude and latitude could vary from a small digit even though they indicate one city. We decide to group cities together if their long & lat deviate within a sum of 2 degrees. 

4. At the end we updated the "city_code" as a concactinated form of:
  -country code
  -city
  -latitude
  -longitude

```{r city code cleaning function, message=FALSE, warning=FALSE, include=FALSE}
cleancity <- function(df = city_summary){
  # create an indicator for each row whether the city code is duplicated
  df <- df%>%
    group_by(city_code)%>%
    mutate(n_city_code=n(), duplicate = if_else(n_city_code > 1, T,F))
  
  # data with duplicated city code
  df_dup <- df%>%
    filter(duplicate == T)
  
  # data with no duplicated city code
  df_no_dup <- df%>%
    filter(duplicate == F)
  
  # duplicated city code vector
  city_code <- unique(df_dup$city_code)
  
  df_clean_citycode <- c()
  # grep("gb_london",city_code )
  # i=2
  for ( i in 1: length(city_code)){
    city_code_i = city_code[i]
    message("city #", i, ":", city_code_i)
    df_dup_i <- df_dup %>%
      filter(city_code == city_code_i)%>%
      arrange(desc(ttl_users))
    

    actual_long <-unlist(df_dup_i[1, long_col <- grep("user_long", colnames(df_dup_i)) ])
    actual_lat <-  unlist(df_dup_i[1,  lat_col <- grep("user_lat", colnames(df_dup_i))])
        
    df_dup_i_check <- df_dup_i %>%
      mutate(long_diff = abs(actual_long- user_long), lat_diff = abs(actual_lat - user_lat), diff_sum = long_diff+ lat_diff)%>%
    mutate(combine = ifelse(diff_sum <= 2 , T, F))
    
    df_cb <- df_dup_i_check%>%
      filter(combine == T)%>%
      group_by(combine)%>%
      summarize(ttl_users = sum(ttl_users), country_code = country_code, city= city,  city_code = city_code)%>%
      mutate(duplicate = F)%>%
      select(-combine)%>%
      distinct(city_code, .keep_all = T)

    df_nocb <- df_dup_i_check%>%
      filter(combine == F)%>%
      select(country_code, city, city_code, ttl_users, duplicate)
   
    df_output <- rbind(df_cb, df_nocb) 
    df_clean_citycode <- rbind(df_clean_citycode, df_output)
    }
    
 return(df_clean_citycode)
}
```

# City Level Github Users
```{r city code and visualization, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# glimpse(cities_maxmind)
# table(cities_maxmind$Country)

# world cities data
cities_maxmind_clean <- cities_maxmind%>%
  mutate(city_code  = paste(Country, City, sep="_"))%>%
  mutate(long = round(Longitude, digits=0), lat = round(Latitude, digits=0))

cities_maxmind_clean$city_code <- str_replace_all(cities_maxmind_clean$city_code, fixed(" "), "")

# gh user data
city_summary <-  users_gh%>%
  filter(!is.na(country_code))%>%
  filter(!is.na(city))%>%
  mutate(city = str_to_lower(city)) %>%
  mutate(user_long = round(long,digits=0), user_lat = round(lat, digits=0))%>%
  group_by(country_code, city, user_long, user_lat)%>%
  summarize(ttl_users = n())%>%
  arrange(desc(ttl_users))%>%
  filter(!is.na(city))%>%
  mutate(city_code  = paste(country_code, city, sep="_"))
city_summary$city_code <- str_replace_all(city_summary$city_code, fixed(" "), "")


city_clean_final <- cleancity(city_summary)

city_clean_final_top <- city_clean_final%>%
   top_n(n= 10, wt = ttl_users)

city_clean_final_top$city_code <- factor(city_clean_final_top$city_code, levels = city_clean_final_top$city_code[order(city_clean_final_top$ttl_users)])

ggplot(city_clean_final_top, aes(x = city_code, y = ttl_users)) +
  geom_point()  +
  aes(colour = country_code) + theme(legend.position = "right") + 
  labs(title = "Cities where Github users are located", x = "city", y = "total number of users") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


```{r top users, eval=FALSE, include=FALSE}
# topuser <- commits%>%
#   group_by(login)%>%
#   dplyr::summarize(ttl_commit = n(), .groups = "keep")%>%
#   arrange(desc(ttl_commit))%>%
#   top_n(n= 10)
```


